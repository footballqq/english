# kid_quiz.html 功能扩展与错题本/复习模式改造计划（基于 razfulltranslate3.csv + localStorage）

## 一、数据结构与本地存储设计

1. **统一词汇模型**
   - 从 `razfulltranslate3.csv` 中解析出结构化数据：
     - `razz_level`（RAZ 等级，如 aa、bb）
     - `book_title`（书名）
     - `word_en`（英文单词）
     - `word_zh`（中文释义）
   - 在前端 JS 中构建：
     - `allWordsByLevel: { [level: string]: Word[] }`
     - `errorBookByLevel: { [level: string]: WordState[] }`
     - `masteredByLevel: { [level: string]: WordState[] }`

2. **localStorage 约定键**
   - `kidquiz_error_<level>`：该等级错题本数组，元素包含：
     - `word_en`, `word_zh`, `last_wrong_at`, `wrong_count`, `last_review_at` 等。
   - `kidquiz_mastered_<level>`：该等级“正确词汇本”数组：
     - `word_en`, `word_zh`, `first_right_at`, `review_history` 等。
   - `kidquiz_settings`：用户偏好配置：
     - 默认等级、每次考试题量、是否排除已掌握单词、是否只出错题本等。

3. **错题/正确词汇状态流转规则**
   - **考试/复习时答错**：
     - 若不在错题本，加入 `error_<level>`，`wrong_count = 1`；
     - 若已在错题本，`wrong_count++`，更新 `last_wrong_at`；
     - 若在 mastered，则可视情况从 mastered 中移除或标记“回退”。
   - **考试/复习时答对**：
     - 若该词在错题本中：从 `error_<level>` 删除，加入或更新 `mastered_<level>`；
     - 若不在错题本：直接加入 `mastered_<level>`（只记录一次正确也可以配置成“多次正确才算掌握”，后续可扩展）。

4. **艾宾浩斯复习提示数据**
   - 在 `mastered` 和 `error` 记录中维护最近复习时间：
     - 根据简单规则（例如 1 天、2 天、4 天、7 天…）计算“推荐复习”的单词数量；
   - 在首页显示：
     - “今天建议复习：X 个错题，Y 个已掌握词汇（按艾宾浩斯间隔）”。

---

## 二、界面与交互改造（kid_quiz.html）

1. **首页（选择区 + 使用说明按钮）**
   - 新增控件：
     - 级别下拉框：从 `razfulltranslate3.csv` 实际存在的 `RAZ Level` 动态填充；
     - 题量输入/选择（如 10 / 20 / 50 / 自定义）；
     - 题源选择：
       - “全部单词”
       - “只从错题本出题”（该等级）
       - “排除已掌握词汇”（从剩余词集合中出题）
       - “只从已掌握词汇出题”（强化巩固）
     - 模式选择：
       - “考试模式”
       - “复习模式”
   - 新增“使用说明”按钮：
     - 弹出模态框或切换到说明区域，解释：
       - 等级/题量/错题本/正确词汇本含义；
       - localStorage 保存位置、清空浏览器数据会丢失等；
       - 推荐的艾宾浩斯复习节奏。

2. **考试模式改造**
   - 题目生成逻辑：
     - 依据选中的 `level`，获取该等级所有单词；
     - 按选择的题源（全部 / 错题本 / 排除 mastered / 仅 mastered）过滤；
     - 按题量随机抽取题目列表。
   - 出题形式：
     - 沿用当前“判断对错”交互（显示中/英之一，用户点“认识/不认识”）；
     - 同时在顶部显示：
       - 当前等级、题源类型、总题数、当前题号、已答对/错统计。
   - 考试结束：
     - 根据用户选择，是否将错题写入本地错题本（默认勾选“写入错题本”）；
     - 正确题更新“正确词汇本”；
     - 显示本次考试统计（正确率、错题数量、新增错题/从错题本移除的数量）。

3. **复习模式新增**
   - 入口：
     - 首页模式选择为“复习模式”，再选“全部单词”或“只看错题本”；
   - 交互方式：
     - 每次取一个单词（默认英文），隐藏中文释义；
     - 用户点击“显示答案”按钮后展示中文；
     - 用户再评价：认识 / 模糊 / 不认识（可简化为 认识 / 不认识）：
       - 认识：可视作一次“正确复习”，更新 mastered，并从错题本移除；
       - 不认识：保持在错题本中或增加 wrong_count；
     - 每轮出固定数量（如 5 个），支持“下一组”。
   - 对错题本复习：
     - 只从该 `level` 的错题本抽取；
     - 复习正确的错题从错题本移除，加入正确词汇本。

4. **错题本管理界面（可简单放在结果页或单独 tab）**
   - 列出当前等级的错题：
     - 单词、中文释义、错次数、最近一次出错时间；
   - 提供操作：
     - “全部清空本等级错题本”按钮（带确认对话框）；
     - “导出错题本文本”按钮（将当前等级错题复制到剪贴板）。

---

## 三、逻辑与实现步骤拆解

1. **CSV 解析与内存模型适配 razfulltranslate3.csv**
   - 确认 `razfulltranslate3.csv` 的具体列含义（现有示例中前几列含有 level、中文标题、英文标题与中英词列）；
   - 在 JS 中实现新的 `parseRazFullTranslateCsv` 函数：
     - 支持按行解析 level/title/word_en/word_zh；
     - 构建 `allWordsByLevel`、并提供 `getWordsByLevel(level)` 的工具函数。

2. **localStorage 工具模块**
   - 封装读写函数：
     - `loadErrorBook(level): WordState[]`
     - `saveErrorBook(level, list: WordState[])`
     - `loadMastered(level): WordState[]`
     - `saveMastered(level, list: WordState[])`
     - `loadSettings()` / `saveSettings()`
   - 处理 JSON 解析错误、无数据时返回空数组。

3. **题目生成器与模式调度器**
   - 实现统一的“题目生成”入口：
     - 入参：`level`, `mode`, `sourceType`, `limit`；
     - 返回：题目数组（带中英词与题型/模式标志）。
   - 模式调度：
     - 考试模式：使用现有的 `startGame` / `displayNextWord` / `handleAnswer` 结构，但改用新题目数组与错题/正确本更新逻辑；
     - 复习模式：新增一套 UI 与状态管理函数（尽量共用工具函数，减少重复逻辑）。

4. **错题本与正确词汇本更新逻辑**
   - 抽象两个工具函数：
     - `recordWrong(level, word)`：更新 localStorage 错题本；
     - `recordRight(level, word)`：在必要时从错题本移除并加入 mastered；
   - 考试和复习模式共用这些工具函数，保证行为一致。

5. **艾宾浩斯复习提示**
   - 在页面初始化时：
     - 扫描所有 level 的 error/mastered 数据；
     - 根据时间间隔规则计算“建议复习数量”；
   - 在首页展示一段简要提示：
     - 例如：“建议今天复习：aa 等级错题 12 个（上次错误 > 3 天）、已掌握词汇 20 个（上次复习 > 7 天）”；
   - 后续可扩展为按级别查看详细复习建议。

6. **使用说明区域/弹窗**
   - 在首页新增“使用说明”按钮：
     - 内容包括：
       - 如何选择等级、题量；
       - 错题本与正确词汇本的保存位置与作用；
       - 复习模式与艾宾浩斯曲线的简述；
       - 如何在平板/手机上“添加到主屏幕”。

---

## 四、测试与验证计划

> 由于 `kid_quiz.html` 主要是前端交互，单测将以 JS 逻辑为主（可在独立 JS 文件中抽出非 DOM 函数用于测试），同时搭配人工验证。

1. **JS 逻辑单元测试（建议）**
   - 若后续拆分出独立 JS 文件（如 `kid_quiz_logic.js`），可用简单测试框架或 Node + jsdom 做单测：
     - CSV 解析函数：输入小样本 `razfulltranslate3` 片段，检查生成的 `allWordsByLevel` 是否正确；
     - localStorage 工具：用 mock storage 验证读写与空数据行为；
     - 题目生成器：在不同模式（全部/错题本/排除 mastered）下，检查输出集合是否符合预期过滤规则。

2. **浏览器手工测试用例**
   - **场景 1：首次访问**
     - 无任何 localStorage 数据，选择 aa 等级 + 考试模式 + 题量 10；
     - 完成考试后，确认错题本与正确词汇本写入成功；
     - 刷新页面后仍能读取错题本和 mastered 统计。
   - **场景 2：从错题本出题**
     - 只选错题本出题，确认仅出现错题本中的单词；
     - 正确回答后，该单词不再出现在错题本出题模式中。
   - **场景 3：复习模式**
     - 选择“复习模式 + aa 等级 + 错题本”，验证：
       - 显示英文、点击按钮显示中文；
       - 选择“认识”后从错题本移除并进入 mastered。
   - **场景 4：艾宾浩斯提示**
     - 通过手动调整 localStorage 中的时间戳或等待一段时间，验证首页提示的数量和文字是否合理。

3. **兼容性与设备测试**
   - 在 Chrome（桌面 + Android 平板）上检查：
     - localStorage 是否正常持久化；
     - UI 布局在竖屏、横屏下是否可用；
     - 按键交互（左右方向键）与按钮点击是否都可用。

---

## 五、实施顺序建议

1. **阶段一：数据与存储基础**
   - 解析 `razfulltranslate3.csv` 到新的结构；
   - 实现 localStorage 工具与错题/正确本的数据结构；
   - 简单在控制台输出加载结果，确认无误。

2. **阶段二：考试模式重构**
   - 新的题目生成逻辑（支持级别、题量、题源过滤）；
   - 将现有考试 UI 接上新的题目对象；
   - 在考试结束时更新错题本与正确词汇本。

3. **阶段三：复习模式与错题本入口**
   - 新增复习模式 UI 与流程；
   - 增加“从错题本考试”的选项；
   - 完成错题本增删逻辑。

4. **阶段四：艾宾浩斯提示与使用说明**
   - 实现简单的复习间隔计算与首页提示；
   - 增加“使用说明”按钮与说明内容。

5. **阶段五：完善与调优**
   - 调整移动端样式、字号和按钮布局；
   - 根据使用体验优化默认题量、默认模式和提示文案。

